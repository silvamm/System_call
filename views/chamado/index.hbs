{{#section 'css'}}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
{{/section}}

<form action="/chamado/lista" method="get">
  <section class="card">
    <div class="card-header">Filtros</div>
    <div class="card-body">
      <div class="row">

        <div class="col-12 col-sm-12 
        {{#if session.usuario.admin}}
           col-md-6 col-lg-6 col-xl-3
        {{else}}
          col-md-12 col-lg-12 col-xl-3
        {{/if}}">

          <div class="form-group">
             <select class="form-control" name="status">
              <option value="" {{selected '' ./query.status}}>Todos os chamados</option>
              <option value="0" {{selected '0' ./query.status}}>Chamados pendentes</option>
              <option value="1" {{selected '1' ./query.status}}>Chamados visualizados</option>
              <option value="2" {{selected '2' ./query.status}}>Chamados aceitos</option>
              <option value="3" {{selected '3' ./query.status}}>Chamados encerrados</option>
            </select>
          </div>
        </div>

        {{#if session.usuario.admin}}
        <div class="col-12 col-sm-12 col-md-6 col-lg-6 col-xl-2">
          <div class="form-group">

            <select class="form-control" name="setor[id]">
              <option value="">Todos os setores</option>
              {{#each setores}}
              <option value="{{id}}"{{selected id ../query.idSetor}}>{{nome}}</option>
              {{/each}}
            </select>
          </div>
        </div>
        {{/if}}

        <div class="col-12 col-sm-12 col-md-12 col-lg-12  
        {{#if session.usuario.admin}}
          col-xl-5
        {{else}}
          col-xl-7
        {{/if}}">
          <div class="form-group">
            <input class="form-control" type="search" value="{{query.protocolo}}" placeholder="Protocolo"
              name="protocolo">
          </div>
        </div>

        <div class="col-6 col-sm-6 col-md-6 col-lg-6 col-xl-2">
          <div class="form-group">
            <button class="btn btn-primary btn-block float-right"><i class="fa fa-search"></i> Buscar</button>
          </div>
        </div>

      </div>

    </div>
  </section>
</form>

<section class="card">
  <div class="card-header">
    {{#unless session.usuario.admin}}Meus {{/unless}}Chamados</div>
  <div class="card-body">

    {{#unless session.usuario.admin}}
    <div class="row">
      <div class="col">
        <a class="btn btn-primary float-right mb-2" href="/chamado"><i class="fa fa-plus"></i> Abrir chamado</a>
      </div>
    </div>
    {{/unless}}

    {{#if chamados}}
    <div class="table-responsive-xl">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th scope="col">Protocolo</th>
            <th scope="col">Problema</th>
            {{#if session.usuario.admin}}<th scope="col">Setor</th>{{/if}}
            <th scope="col">Prioridade</th>
            <th scope="col">Situação</th>
            <th scope="col" style="width: 30%;" class="text-center col-lg-4">Ações</th>
          </tr>
        </thead>
        <tbody>
          {{#each chamados}}
          <tr>
            <td>{{protocolo}}</td>
            <td>{{problema.nome}}</td>
            {{#if ../session.usuario.admin}}<td>{{criadoPor.setor.nome}}</td>{{/if}}
            <td>{{prioridade}}</td>
            <td id="status-{{id}}">{{status}}</td>
            <td class="text-center">
              {{#if ../session.usuario.admin}}
              <button id="btnAceitar-{{id}}" style="width: 95px;" onclick="aceitar({{id}})" class="btn btn-success btn-sm"><i class="fa fa-check"></i> Aceitar</button>
              {{/if}}
              <button style="width: 95px;" onclick="visualizar({{id}})" class="btn btn-primary btn-sm my-sm-1"><i class="fa fa-eye"></i> Detalhes</a>
              {{#if ../session.usuario.admin}}
              <button id="btnEncerrar-{{id}}" style="width: 95px;" onclick="encerrar({{id}})" class="btn btn-danger btn-sm "><i class="fa fa-times "></i> Encerrar</button>
              {{/if}}
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
    {{else}}
    <div class="row">
      <div class="col text-center">
        <p style="font-size: 24px;">Nenhum registro encontrado</p>
      </div>
    </div>
    {{/if}}
  </div>
</section>

{{#section 'js'}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
function aceitar(id){
  $.ajax({
    type: 'post',
    url: '/chamado/status/' + id,
    data: { status : 'ACEITO' }
  }).done((resultado)=> {

    if(resultado == 'Accepted')
      return toastr.warning('Chamado já esta aceito!', 'Atenção!', {progressBar : true, timeOut: 5000})   
    
    $('#status-' + id).html(resultado.status)
    $('#btnAceitar-'+ id).prop('disabled', true)
    toastr.success('Chamado aceito com sucesso!', 'Aceito!', {progressBar : true, timeOut: 5000})

  }).fail((error)=>{
       toastr.error('Não foi possivel realizar a operação!', 'Falha!', {progressBar : true, timeOut: 5000})
  })
}
function encerrar(id){
  $.ajax({
    type: 'post',
    url: '/chamado/status/' + id, 
    data: { status: 'ENCERRADO' }
 }).done((resultado)=> {

    if(resultado == 'Accepted')
      return toastr.warning('Chamado já esta encerrado!', 'Atenção!', {progressBar : true, timeOut: 5000})   

   $('#status-' + id).html(resultado.status)
   $('#btnEncerrar-'+ id).prop('disabled', true)
   toastr.success('Chamado encerrado com sucesso!', 'Encerrado!', {progressBar : true, timeOut: 5000})

 }).fail((error)=>{
      toastr.error('Não foi possivel realizar a operação!', 'Falha!', {progressBar : true, timeOut: 5000})
  })
}
function visualizar(id){
  $.ajax({
    type: 'post',
    url: '/chamado/status/' + id, 
    data: { status: 'VISUALIZADO' }
  }).done((resultado)=> {
    window.location =  "/chamado/" + id
  }).fail((error)=>{
    toastr.error('Não foi possivel realizar a operação!', 'Falha!', {progressBar : true, timeOut: 5000})
  })
}

</script>
{{/section}}